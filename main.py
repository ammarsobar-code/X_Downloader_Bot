import os, telebot, yt_dlp, time
from telebot import types
from flask import Flask
from threading import Thread

# --- 1. Ø³ÙŠØ±ÙØ± Flask ---
app = Flask('')
@app.route('/')
def home(): return "X Video Direct Downloader"
def run(): app.run(host='0.0.0.0', port=8080)
def keep_alive():
    t = Thread(target=run)
    t.daemon = True
    t.start()

# --- 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ---
API_TOKEN = os.getenv('BOT_TOKEN')
SNAP_LINK = "https://snapchat.com/t/wxsuV6qD" 
bot = telebot.TeleBot(API_TOKEN)
user_status = {}

# --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø±Ø³Ø§Ø¦Ù„ Ù…Ù†ÙØµÙ„Ø© ---
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.chat.id
    welcome_text = (
        "Ø§Ù‡Ù„Ø§ Ø¨Ùƒ ğŸ‘‹ğŸ¼\n"
        "Ø´ÙƒØ±Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ Ù…Ù‚Ø§Ø·Ø¹ Ù…Ù†ØµØ© Ø§ÙƒØ³ \n"
        "Ø£ÙˆÙ„Ø§ Ø³ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø³Ø§Ø¨ÙŠ ÙÙŠ Ø³Ù†Ø§Ø¨ Ø´Ø§Øª Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\n\n"
        "Welcome ğŸ‘‹ğŸ¼\n"
        "Thank you for using X Download Bot \n"
        "First, you'll need to follow my Snapchat account to activate the bot"
    )
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ‘» Follow", url=SNAP_LINK))
    markup.add(types.InlineKeyboardButton("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ğŸ”“ Activate", callback_data="step_1"))
    bot.send_message(user_id, welcome_text, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: True)
def handle_verification(call):
    user_id = call.message.chat.id
    if call.data == "step_1":
        fail_msg = (
            "Ù†Ø¹ØªØ°Ø± Ù…Ù†Ùƒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØ§Ø¨Ø¹ØªÙƒ Ù„Ø­Ø³Ø§Ø¨ Ø³Ù†Ø§Ø¨ Ø´Ø§Øª âŒğŸ‘»\n"
            "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø³Ù†Ø§Ø¨ Ø´Ø§Øª ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ğŸ”“\n\n"
            "We apologize, but your Snapchat account follow request has not been verified. âŒğŸ‘»\n"
            "Please click \"Follow Account\" and you will be redirected to Snapchat. After following, click the \"Activate\" button. ğŸ”“"
        )
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ‘» Follow", url=SNAP_LINK))
        markup.add(types.InlineKeyboardButton("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ğŸ”“ Activate", callback_data="step_2"))
        bot.send_message(user_id, fail_msg, reply_markup=markup)
    elif call.data == "step_2":
        user_status[user_id] = "verified"
        bot.send_message(user_id, "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­ âœ…\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ğŸ”—\n\nThe bot has been successfully activated âœ…\nPlease send the link ğŸ”—")

# --- 4. Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø¥Ø±Ø³Ø§Ù„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù†ÙØµÙ„Ø©) ---
@bot.message_handler(func=lambda message: True)
def handle_x_download(message):
    user_id = message.chat.id
    url = message.text.strip()

    if user_status.get(user_id) != "verified":
        send_welcome(message)
        return

    if "x.com" in url or "twitter.com" in url:
        prog = bot.reply_to(message, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ... â³\nLoading... â³")
        
        # Ø®ÙŠØ§Ø±Ø§Øª Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙ‚Ø· Ø¨Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø©
        ydl_opts = {
            'quiet': True,
            'no_warnings': True,
            'format': 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best',
        }
        
        try:
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(url, download=False)
                found_any_video = False

                # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØºØ±ÙŠØ¯Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
                if 'entries' in info:
                    for entry in info['entries']:
                        video_url = entry.get('url')
                        # Ù†ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙØ¹Ù„Ø§Ù‹
                        if video_url and (entry.get('vcodec') != 'none' or '.mp4' in video_url):
                            bot.send_video(user_id, video_url)
                            found_any_video = True
                
                # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØºØ±ÙŠØ¯Ø© ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø­Ø¯
                elif info.get('url'):
                    video_url = info.get('url')
                    if info.get('vcodec') != 'none' or '.mp4' in video_url:
                        bot.send_video(user_id, video_url)
                        found_any_video = True

                if found_any_video:
                    bot.send_message(user_id, "ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ âœ…\nDone âœ…")
                else:
                    bot.edit_message_text("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·.", user_id, prog.message_id)
                
                bot.delete_message(user_id, prog.message_id)

        except Exception as e:
            bot.edit_message_text("Ù†Ø¹ØªØ°Ø± Ù…Ù†Ùƒ Ù†ÙˆØ§Ø¬Ù‡ Ø§Ù„Ø§Ù† Ù…Ø´ÙƒÙ„Ù‡ ØªÙ‚Ù†ÙŠØ© ÙˆØ³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª âŒ\n\nWe apologize, we are currently experiencing a technical issue and it will be resolved as soon as possible âŒ", user_id, prog.message_id)
    else:
        bot.reply_to(message, "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ âŒ\nPlease send the correct link âŒ")

if __name__ == "__main__":
    keep_alive()
    bot.remove_webhook()
    time.sleep(1)
    bot.infinity_polling()
